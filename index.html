<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Note C√¥ng Vi·ªác - KEN MEDIA</title>
  <style>
    /* C√°c style c∆° b·∫£n */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    /* Sidebar */
    #sidebar {
      width: 220px;
      background: #f4f4f4;
      border-right: 1px solid #ddd;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #sidebar h3 {
      margin-top: 0;
      text-align: center;
    }
    .note-item {
      padding: 4px;
      margin: 4px 0;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    /* N·∫øu ghi ch√∫ ƒë∆∞·ª£c ƒë√°nh d·∫•u quan tr·ªçng (v∆∞∆°ng mi·ªán) th√¨ thay ƒë·ªïi m√†u n·ªÅn */
    .note-item.important {
      background-color: #ffe0e0;
    }
    /* Khi note ƒë∆∞·ª£c ch·ªçn (active) th√¨ n·ªÅn s·∫Ω hi·ªÉn th·ªã m√†u xanh nh·∫°t */
    .note-item.active {
      background-color: #cceeff;
    }
    .note-item.dragging {
      opacity: 0.5;
    }
    .note-item input[type="checkbox"] {
      margin-right: 5px;
    }
    .note-item span {
      flex: 1;
    }
    /* Ph·∫ßn ghi ch√∫ ch√≠nh */
    #main {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    /* Header c·ªßa note: hi·ªÉn th·ªã ti√™u ƒë·ªÅ v√† c√°c n√∫t, cƒÉn gi·ªØa */
    #note-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
      font-size: 20px;
      font-weight: bold;
    }
    /* S·∫Øp x·∫øp c√°c n√∫t theo th·ª© t·ª±: X√≥a note - T·∫£i ghi ch√∫ v·ªÅ - Clear Selected - D·∫•u + */
    /* (Kh√¥ng c√≤n n√∫t "Gim Top" ·ªü header) */
    #note-header .buttons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      width: 100%;
      align-items: center;
      flex-wrap: wrap;
    }
    /* Style cho c√°c n√∫t */
    #delete-note {
      background-color: transparent;
      color: red;
      border: 1px solid red;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #download-note {
      background-color: transparent;
      color: red;
      border: 1px solid red;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #clear-selected {
      background-color: #FAFAD2;
      color: black;
      border: 1px solid black;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #add-note {
      background-color: blue;
      color: white;
      border: none;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Box nh·∫≠p n·ªôi dung note */
    #note-content {
      flex: 1;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: none;
      min-height: 60vh;
    }
    /* Ph·∫ßn hi·ªÉn th·ªã th√¥ng tin th·ªùi gian */
    #timestamp {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    /* Custom context menu v·ªõi 4 m·ª•c */
    #context-menu {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .context-menu-item:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <!-- Sidebar ch·ª©a ti√™u ƒë·ªÅ v√† danh s√°ch note -->
  <div id="sidebar">
    <h3>KEN MEDIA</h3>
    <div id="notes-list"></div>
  </div>
  
  <!-- Ph·∫ßn ghi ch√∫ ch√≠nh -->
  <div id="main">
    <div id="note-header">
      <span id="note-title"></span>
      <div class="buttons">
        <button id="delete-note">X√≥a note</button>
        <button id="download-note">T·∫£i ghi ch√∫ v·ªÅ</button>
        <button id="clear-selected">Clear Selected</button>
        <button id="add-note">+</button>
      </div>
    </div>
    <textarea id="note-content" placeholder="nh·∫≠p n·ªôi dung ghi ch√∫ .................."></textarea>
    <div id="timestamp"></div>
  </div>
  
  <!-- Custom context menu v·ªõi 4 m·ª•c -->
  <div id="context-menu">
    <div id="context-download" class="context-menu-item">T·∫£i ghi ch√∫ v·ªÅ .txt</div>
    <div id="context-delete" class="context-menu-item">X√≥a note</div>
    <div id="context-pin" class="context-menu-item"></div>
    <div id="context-important" class="context-menu-item"></div>
  </div>
  
  <script>
    // ---------- H√ÄM H·ªñ TR·ª¢ ----------
    // H√†m pad v·ªõi ƒë·ªëi s·ªë k√≠ch th∆∞·ªõc (default l√† 2)
    function pad(num, size = 2) {
      return String(num).padStart(size, '0');
    }
    // H√†m ƒë·ªãnh d·∫°ng t√™n note:
    // N·∫øu c√≥ customTitle th√¨ d√πng customTitle, ng∆∞·ª£c l·∫°i s·ª≠ d·ª•ng key theo ƒë·ªãnh d·∫°ng "dd/mm/yyyy (HH:MM)".
    // N·∫øu note ƒë∆∞·ª£c "gim top" (pinned) th√¨ th√™m icon üìå, n·∫øu "quan tr·ªçng" th√¨ th√™m icon üëë.
    function formatNoteKey(key, noteObj) {
      let base = "";
      if (noteObj.customTitle && noteObj.customTitle.trim() !== "") {
        base = noteObj.customTitle;
      } else {
        let parts = key.split("_");
        if (parts.length !== 2) return key;
        let dateParts = parts[0].split("-");
        let timeParts = parts[1].split("-");
        if (dateParts.length !== 3 || timeParts.length < 2) return key;
        base = dateParts[2] + "/" + dateParts[1] + "/" + dateParts[0] + " (" + timeParts[0] + ":" + timeParts[1] + ")";
      }
      let prefix = "";
      if (noteObj.pinned) {
         prefix += "üìå ";
      }
      if (noteObj.important) {
         prefix += "üëë ";
      }
      return prefix + base;
    }
    
    // ---------- QU·∫¢N L√ù NOTE & TH·ª® T·ª∞ ----------
    // M·ªói note ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng: { content: string, customTitle: string, important: boolean, pinned: boolean }
    let notes = {};
    let currentNote = null;
    // Hai m·∫£ng l∆∞u th·ª© t·ª± c·ªßa ghi ch√∫ "gim top" (pinned) v√† ch∆∞a "gim top" (unpinned)
    let pinnedNotesOrder = [];
    let unpinnedNotesOrder = [];
    
    // T·∫£i note v√† th·ª© t·ª± t·ª´ localStorage
    function loadNotes() {
      const saved = localStorage.getItem('notes');
      if (saved) {
        try {
          notes = JSON.parse(saved);
          for (let key in notes) {
            if (typeof notes[key] === "string") {
              notes[key] = { content: notes[key], customTitle: "", important: false, pinned: false };
            }
            // ƒê·∫£m b·∫£o c√≥ thu·ªôc t√≠nh pinned (m·∫∑c ƒë·ªãnh false n·∫øu ch∆∞a c√≥)
            if (notes[key].pinned === undefined) {
              notes[key].pinned = false;
            }
            if (notes[key].important === undefined) {
              notes[key].important = false;
            }
          }
        } catch(e) {
          notes = {};
        }
      }
      // Load th·ª© t·ª± t·ª´ localStorage (n·∫øu c√≥)
      const savedPinned = localStorage.getItem('pinnedNotesOrder');
      const savedUnpinned = localStorage.getItem('unpinnedNotesOrder');
      if (savedPinned && savedUnpinned) {
        try {
          pinnedNotesOrder = JSON.parse(savedPinned);
          unpinnedNotesOrder = JSON.parse(savedUnpinned);
        } catch(e) {
          pinnedNotesOrder = [];
          unpinnedNotesOrder = [];
        }
      } else {
        // N·∫øu ch∆∞a c√≥, kh·ªüi t·∫°o t·ª´ c√°c key hi·ªán c√≥
        pinnedNotesOrder = [];
        unpinnedNotesOrder = [];
        Object.keys(notes).forEach(key => {
          if (notes[key].pinned)
            pinnedNotesOrder.push(key);
          else
            unpinnedNotesOrder.push(key);
        });
      }
    }
    function saveNotes() {
      localStorage.setItem('notes', JSON.stringify(notes));
      localStorage.setItem('pinnedNotesOrder', JSON.stringify(pinnedNotesOrder));
      localStorage.setItem('unpinnedNotesOrder', JSON.stringify(unpinnedNotesOrder));
    }
    
    // Render danh s√°ch note trong sidebar theo th·ª© t·ª± (gim top ·ªü tr√™n, sau ƒë√≥ l√† kh√¥ng gim top)
    function renderNotesList() {
      const listDiv = document.getElementById('notes-list');
      listDiv.innerHTML = '';
      
      // Lo·∫°i b·ªè c√°c key kh√¥ng t·ªìn t·∫°i
      pinnedNotesOrder = pinnedNotesOrder.filter(key => notes.hasOwnProperty(key));
      unpinnedNotesOrder = unpinnedNotesOrder.filter(key => notes.hasOwnProperty(key));
      // N·∫øu c√≥ ghi ch√∫ n√†o ch∆∞a c√≥ trong m·∫£ng th·ª© t·ª± th√¨ th√™m v√†o m·∫£ng ph√π h·ª£p
      Object.keys(notes).forEach(key => {
        if (!pinnedNotesOrder.includes(key) && !unpinnedNotesOrder.includes(key)) {
          if (notes[key].pinned)
            pinnedNotesOrder.push(key);
          else
            unpinnedNotesOrder.push(key);
        }
      });
      const orderKeys = pinnedNotesOrder.concat(unpinnedNotesOrder);
      
      orderKeys.forEach(key => {
        const noteObj = notes[key];
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note-item';
        if (noteObj.important) {
          noteDiv.classList.add('important');
        }
        if (key === currentNote) {
          noteDiv.classList.add('active');
        }
        // Cho ph√©p k√©o th·∫£: thi·∫øt l·∫≠p draggable v√† c√°c s·ª± ki·ªán li√™n quan
        noteDiv.setAttribute('draggable', true);
        noteDiv.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', key);
          noteDiv.classList.add('dragging');
        });
        noteDiv.addEventListener('dragend', (e) => {
          noteDiv.classList.remove('dragging');
        });
        noteDiv.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        noteDiv.addEventListener('drop', (e) => {
          e.preventDefault();
          let draggedKey = e.dataTransfer.getData('text/plain');
          if (draggedKey === key) return;
          // Ch·ªâ cho ph√©p k√©o th·∫£ trong c√πng nh√≥m (d·ª±a tr√™n thu·ªôc t√≠nh pinned)
          if (notes[draggedKey].pinned === noteObj.pinned) {
            let arr = noteObj.pinned ? pinnedNotesOrder : unpinnedNotesOrder;
            let fromIndex = arr.indexOf(draggedKey);
            let toIndex = arr.indexOf(key);
            if (fromIndex > -1 && toIndex > -1) {
              arr.splice(fromIndex, 1);
              arr.splice(toIndex, 0, draggedKey);
            }
            saveNotes();
            renderNotesList();
          }
        });
        
        // Checkbox cho multi-select
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = key;
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
        });
        noteDiv.appendChild(checkbox);
        
        // Span ch·ª©a t√™n note
        const span = document.createElement('span');
        span.textContent = formatNoteKey(key, noteObj);
        // Dblclick ƒë·ªÉ ƒë·ªïi t√™n note
        span.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const newName = prompt("Nh·∫≠p t√™n m·ªõi cho note:", noteObj.customTitle || "");
          if (newName !== null) {
            noteObj.customTitle = newName;
            saveNotes();
            renderNotesList();
            if (key === currentNote) {
              document.getElementById('note-title').textContent = "Ghi ch√∫: " + formatNoteKey(key, noteObj);
            }
          }
        });
        noteDiv.appendChild(span);
        
        // Click ƒë∆°n ƒë·ªÉ ch·ªçn note
        noteDiv.addEventListener('click', (e) => {
          // N·∫øu kh√¥ng c√≥ checkbox n√†o ƒë∆∞·ª£c ch·ªçn th√¨ ch·ªâ ch·ªçn note n√†y
          if (document.querySelectorAll('#notes-list input[type="checkbox"]:checked').length === 0) {
            saveCurrentNote();
            displayNote(key);
          }
        });
        
        // Context menu cho note
        noteDiv.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          saveCurrentNote();
          displayNote(key);
          showContextMenu(e.pageX, e.pageY);
        });
        listDiv.appendChild(noteDiv);
      });
    }
    
    function displayNote(key) {
      currentNote = key;
      const noteObj = notes[key];
      document.getElementById('note-title').textContent = "Ghi ch√∫: " + formatNoteKey(key, noteObj);
      document.getElementById('note-content').value = noteObj.content || "";
      renderNotesList();
    }
    
    function saveCurrentNote() {
      if (currentNote !== null) {
        notes[currentNote].content = document.getElementById('note-content').value;
        saveNotes();
      }
    }
    
    // Sinh key cho note m·ªõi theo ƒë·ªãnh d·∫°ng "yyyy-mm-dd_HH-MM-SS-ms"
    function generateNoteKey() {
      const now = new Date();
      return now.getFullYear() + "-" + pad(now.getMonth() + 1) + "-" + pad(now.getDate()) + "_" +
             pad(now.getHours()) + "-" + pad(now.getMinutes()) + "-" + pad(now.getSeconds()) + "-" + pad(now.getMilliseconds(), 3);
    }
    
    function addNewNote() {
      saveCurrentNote();
      const key = generateNoteKey();
      // M·∫∑c ƒë·ªãnh note m·ªõi: ch∆∞a quan tr·ªçng v√† ch∆∞a gim top
      notes[key] = { content: "", customTitle: "", important: false, pinned: false };
      unpinnedNotesOrder.push(key);
      saveNotes();
      displayNote(key);
    }
    
    function deleteCurrentNote() {
      if (currentNote !== null) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y?")) {
          delete notes[currentNote];
          let idx = pinnedNotesOrder.indexOf(currentNote);
          if (idx > -1) pinnedNotesOrder.splice(idx, 1);
          idx = unpinnedNotesOrder.indexOf(currentNote);
          if (idx > -1) unpinnedNotesOrder.splice(idx, 1);
          saveNotes();
          const keys = Object.keys(notes);
          if (keys.length > 0) {
            const orderKeys = pinnedNotesOrder.concat(unpinnedNotesOrder);
            displayNote(orderKeys[0]);
          } else {
            currentNote = null;
            document.getElementById('note-title').textContent = "";
            document.getElementById('note-content').value = "";
          }
          renderNotesList();
        }
      }
    }
    
    function downloadCurrentNote() {
      if (currentNote !== null) {
        const content = notes[currentNote].content || "";
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `note-${currentNote}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }
    
    // X√≥a c√°c note ƒë∆∞·ª£c ch·ªçn (multi-select) trong sidebar
    function clearSelectedNotes() {
      const checkboxes = document.querySelectorAll('#notes-list input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert("Ch∆∞a ch·ªçn note n√†o ƒë·ªÉ x√≥a.");
        return;
      }
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√°c note ƒë∆∞·ª£c ch·ªçn?")) {
        checkboxes.forEach(cb => {
          const key = cb.value;
          delete notes[key];
          let idx = pinnedNotesOrder.indexOf(key);
          if (idx > -1) pinnedNotesOrder.splice(idx, 1);
          idx = unpinnedNotesOrder.indexOf(key);
          if (idx > -1) unpinnedNotesOrder.splice(idx, 1);
          if (key === currentNote) {
            currentNote = null;
          }
        });
        saveNotes();
        const keys = Object.keys(notes);
        if (keys.length > 0) {
          const orderKeys = pinnedNotesOrder.concat(unpinnedNotesOrder);
          displayNote(orderKeys[0]);
        } else {
          document.getElementById('note-title').textContent = "";
          document.getElementById('note-content').value = "";
        }
        renderNotesList();
      }
    }
    
    // ---------- X·ª¨ L√ù CONTEXT MENU ----------
    function showContextMenu(x, y) {
      const menu = document.getElementById('context-menu');
      // C·∫≠p nh·∫≠t n·ªôi dung menu cho m·ª•c "Gim Top" (Pin)
      if (notes[currentNote] && notes[currentNote].pinned) {
        document.getElementById('context-pin').innerHTML = "B·ªè Gim Top <span>üìå</span>";
      } else {
        document.getElementById('context-pin').innerHTML = "Gim Top <span>üìå</span>";
      }
      // C·∫≠p nh·∫≠t n·ªôi dung menu cho m·ª•c "Quan tr·ªçng"
      if (notes[currentNote] && notes[currentNote].important) {
        document.getElementById('context-important').innerHTML = "B·ªè Quan Tr·ªçng <span>üëë</span>";
      } else {
        document.getElementById('context-important').innerHTML = "Quan Tr·ªçng <span>üëë</span>";
      }
      menu.style.top = y + 'px';
      menu.style.left = x + 'px';
      menu.style.display = 'block';
    }
    document.addEventListener('click', () => {
      document.getElementById('context-menu').style.display = 'none';
    });
    document.getElementById('context-download').addEventListener('click', (e) => {
      e.stopPropagation();
      downloadCurrentNote();
      document.getElementById('context-menu').style.display = 'none';
    });
    document.getElementById('context-delete').addEventListener('click', (e) => {
      e.stopPropagation();
      deleteCurrentNote();
      document.getElementById('context-menu').style.display = 'none';
    });
    document.getElementById('context-pin').addEventListener('click', (e) => {
      e.stopPropagation();
      togglePinCurrentNote();
      document.getElementById('context-menu').style.display = 'none';
    });
    document.getElementById('context-important').addEventListener('click', (e) => {
      e.stopPropagation();
      toggleImportantCurrentNote();
      document.getElementById('context-menu').style.display = 'none';
    });
    
    // H√†m toggle "Gim Top" (pin) cho ghi ch√∫ hi·ªán t·∫°i
    function togglePinCurrentNote() {
      if (currentNote !== null) {
        if (pinnedNotesOrder.includes(currentNote)) {
          // N·∫øu ƒëang gim top ‚Üí b·ªè gim
          let idx = pinnedNotesOrder.indexOf(currentNote);
          if (idx > -1) pinnedNotesOrder.splice(idx, 1);
          if (!unpinnedNotesOrder.includes(currentNote)) {
            unpinnedNotesOrder.push(currentNote);
          }
          notes[currentNote].pinned = false;
        } else {
          // N·∫øu ch∆∞a gim top ‚Üí chuy·ªÉn sang gim top
          let idx = unpinnedNotesOrder.indexOf(currentNote);
          if (idx > -1) unpinnedNotesOrder.splice(idx, 1);
          if (!pinnedNotesOrder.includes(currentNote)) {
            pinnedNotesOrder.unshift(currentNote);
          }
          notes[currentNote].pinned = true;
        }
        saveNotes();
        renderNotesList();
        if (currentNote !== null) {
          document.getElementById('note-title').textContent = "Ghi ch√∫: " + formatNoteKey(currentNote, notes[currentNote]);
        }
      }
    }
    
    // H√†m toggle "Quan tr·ªçng" cho ghi ch√∫ hi·ªán t·∫°i
    function toggleImportantCurrentNote() {
      if (currentNote !== null) {
        notes[currentNote].important = !notes[currentNote].important;
        saveNotes();
        renderNotesList();
        if (currentNote !== null) {
          document.getElementById('note-title').textContent = "Ghi ch√∫: " + formatNoteKey(currentNote, notes[currentNote]);
        }
      }
    }
    
    // ---------- HI·ªÇN TH·ªä TH√îNG TIN TH·ªúI GIAN ----------
    function updateTimeInfo() {
      let now = new Date();
      let dd = pad(now.getDate());
      let mm = pad(now.getMonth() + 1);
      let yyyy = now.getFullYear();
      let hh = pad(now.getHours());
      let min = pad(now.getMinutes());
      let ss = pad(now.getSeconds());
      
      let line1 = `Ng√†y: ${dd} - Th√°ng: ${mm} - NƒÉm: ${yyyy} - D∆∞∆°ng L·ªãch: ${dd}/${mm}/${yyyy}`;
      // T√≠nh √Çm l·ªãch theo d∆∞∆°ng l·ªãch hi·ªán t·∫°i (m√∫i gi·ªù +7)
      let lunar = convertSolar2Lunar(parseInt(dd), parseInt(mm), yyyy, 7);
      let lunarDay = pad(lunar[0]);
      let lunarMonth = pad(lunar[1]);
      let lunarYear = lunar[2];
      line1 += ` - √Çm L·ªãch: ${lunarDay}/${lunarMonth}/${lunarYear}${lunar[3] ? " (Nhu·∫≠n)" : ""}`;
      let line2 = `Gi·ªù Vi·ªát Nam: ${hh}:${min}:${ss}`;
      document.getElementById('timestamp').innerHTML = line1 + "<br>" + line2;
    }
    setInterval(updateTimeInfo, 1000);
    
    // ---------- CHUY·ªÇN ƒê·ªîI D∆Ø∆†NG L·ªäCH -> √ÇM L·ªäCH ----------
    const PI = Math.PI;
    function INT(d) {
      return Math.floor(d);
    }
    function jdFromDate(dd, mm, yy) {
      var a = INT((14 - mm) / 12);
      var y = yy + 4800 - a;
      var m = mm + 12 * a - 3;
      var jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - INT(y / 100) + INT(y / 400) - 32045;
      if (jd < 2299161) {
        jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - 32083;
      }
      return jd;
    }
    function jdToDate(jd) {
      var a, b, c, d, e, m;
      if (jd > 2299160) {
        a = jd + 32044;
        b = INT((4 * a + 3) / 146097);
        c = a - INT((b * 146097) / 4);
      } else {
        b = 0;
        c = jd + 32082;
      }
      d = INT((4 * c + 3) / 1461);
      e = c - INT((1461 * d) / 4);
      m = INT((5 * e + 2) / 153);
      var day = e - INT((153 * m + 2) / 5) + 1;
      var month = m + 3 - 12 * INT(m / 10);
      var year = b * 100 + d - 4800 + INT(m / 10);
      return [day, month, year];
    }
    function NewMoon(k) {
      var T = k / 1236.85;
      var T2 = T * T;
      var T3 = T2 * T;
      var dr = PI / 180;
      var Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
      Jd1 = Jd1 + 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
      var M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
      var Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
      var F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
      var C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) +
               0.0021 * Math.sin(2 * dr * M) -
               0.4068 * Math.sin(Mpr * dr) +
               0.0161 * Math.sin(2 * dr * Mpr) - 
               0.0004 * Math.sin(3 * dr * Mpr);
      C1 = C1 + 0.0104 * Math.sin(2 * dr * F) -
           0.0051 * Math.sin(dr * (M + Mpr)) -
           0.0074 * Math.sin(dr * (M - Mpr)) +
           0.0004 * Math.sin(dr * (2 * F + M)) -
           0.0004 * Math.sin(dr * (2 * F - M)) -
           0.0006 * Math.sin(dr * (2 * F + Mpr)) +
           0.0010 * Math.sin(dr * (2 * F - Mpr)) +
           0.0005 * Math.sin(dr * (2 * Mpr + M));
      var deltaT;
      if (T < -11) {
        deltaT = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
      } else {
        deltaT = -0.000278 + 0.000265 * T + 0.000262 * T2;
      }
      var JdNew = Jd1 + C1 - deltaT;
      return JdNew;
    }
    function SunLongitude(jdn) {
      var T = (jdn - 2451545.0) / 36525;
      var T2 = T * T;
      var dr = PI / 180;
      var M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
      var L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;
      var DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
      DL = DL + (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
      var L = L0 + DL;
      L = L * dr;
      L = L - Math.PI * 2 * INT(L / (Math.PI * 2));
      return L;
    }
    function getSunLongitude(dayNumber, timeZone) {
      return SunLongitude(dayNumber - 0.5 - timeZone / 24);
    }
    function getLunarMonth11(yy, timeZone) {
      var off = jdFromDate(31, 12, yy) - 2415021;
      var k = INT(off / 29.530588853);
      var nm = NewMoon(k);
      var sunLong = getSunLongitude(INT(nm + 0.5), timeZone);
      if (sunLong >= 3 * Math.PI / 2)
        nm = NewMoon(k - 1);
      return INT(nm + 0.5);
    }
    function getLeapMonthOffset(a11, timeZone) {
      var k = INT(0.5 + (a11 - 2415021.076998695) / 29.530588853);
      var last = 0;
      var i = 1;
      var arc = getSunLongitude(NewMoon(k + i), timeZone);
      do {
        last = arc;
        i++;
        arc = getSunLongitude(NewMoon(k + i), timeZone);
      } while (arc != last && i < 14);
      return i - 1;
    }
    function convertSolar2Lunar(dd, mm, yy, timeZone) {
      var dayNumber = jdFromDate(dd, mm, yy);
      var k = INT((dayNumber - 2415021.076998695) / 29.530588853);
      var monthStart = NewMoon(k + 1);
      if (monthStart > dayNumber + 1) {
        monthStart = NewMoon(k);
      }
      var a11 = getLunarMonth11(yy, timeZone);
      var b11 = a11;
      var lunarYear;
      if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1, timeZone);
      } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1, timeZone);
      }
      var lunarDay = Math.round(dayNumber - monthStart + 1);
      var diff = INT((monthStart - a11) / 29);
      var lunarMonth = diff + 11;
      var leap = 0;
      if (b11 - a11 > 365) {
        var leapMonthDiff = getLeapMonthOffset(a11, timeZone);
        if (diff >= leapMonthDiff) {
          lunarMonth = diff + 10;
          if (diff == leapMonthDiff) {
            leap = 1;
          }
        }
      }
      if (lunarMonth > 12) {
        lunarMonth = lunarMonth - 12;
      }
      if (lunarMonth >= 11 && diff < 4) {
        lunarYear -= 1;
      }
      return [lunarDay, lunarMonth, lunarYear, leap];
    }
    
    // ---------- KH·ªûI T·∫†O ·ª®NG D·ª§NG ----------
    function init() {
      loadNotes();
      renderNotesList();
      if (Object.keys(notes).length > 0) {
        // N·∫øu c√≥ ghi ch√∫, hi·ªÉn th·ªã note ƒë·∫ßu ti√™n theo th·ª© t·ª± l∆∞u
        const orderKeys = pinnedNotesOrder.concat(unpinnedNotesOrder);
        displayNote(orderKeys[0]);
      } else {
        addNewNote();
      }
    }
    window.addEventListener('load', init);
    
    // ---------- S·ª∞ KI·ªÜN CHO C√ÅC N√öT ----------
    document.getElementById('add-note').addEventListener('click', addNewNote);
    document.getElementById('download-note').addEventListener('click', downloadCurrentNote);
    document.getElementById('delete-note').addEventListener('click', deleteCurrentNote);
    document.getElementById('clear-selected').addEventListener('click', clearSelectedNotes);
    // Auto l∆∞u n·ªôi dung note khi ng∆∞·ªùi d√πng nh·∫≠p (ƒë·ªÉ khi refresh v·∫´n l∆∞u l·∫°i n·ªôi dung)
    document.getElementById('note-content').addEventListener('input', saveCurrentNote);
    
  </script>
</body>
</html>
